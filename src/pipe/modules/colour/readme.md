# colour processing

this is a unified module to handle important things concerning colour.
the input is in camera rgb and the output will be rec2020.

it supports two modes of operation: using 3x3 colour matrices and profiles
created from spectral response curves of the cameras colour filter array (CFA).
to use such a profile, first [create one for your camera using the profiling
toolchain](../../../tools/clut/readme.md). then set the `matrix` parameter to `clut`.
to route the profile data to the input here, there is a `clut.pst` preset.

the second, more simplistic mode of operation applies a 3x3 matrix. this kind
of input transform is known to be imprecise especially for saturated colours
and produce all kinds of artifacts (say way out of gamut dark blue tones). to
alleviate this, this module comes with a corrective radial basis function (RBF)
applied after white balance and matrix (or clut). it allows to map arbitrary
source to target points in 2d chromaticity space.

this mechanism be used to calibrate the input colour against a measured
test chart (for instance an IT8), or for artistic colour manipulation.

the chromaticity RBF operates in rec2020, normalised to r/(r+g+b) and b/(r+g+b).

white balancing (using CAT16) will adjust rec2020 D65 white to the colour
represented by the three white sliders. to input alternative source colours
instead of D65, connect the `picked` input from an instance of a [colour picker
module](../pick/readme.md), operating on the input to this colour module. the
picked patch will be used as source colour and white balancing will be adjusted
such that it will match the destination colour defined by the sliders. in
conjunction with skin tone presets (cf. `colour-monk-[0-9].pst`), this is
useful to match skin rendition precisely in difficult lighting situations.

## parameters

* `exposure` this is here for convenience, so we save the memory bandwidth to carry
  all the pixels to yet another module doing a trivial transform on the input data.
* `sat` saturation control using dt UCS
* `mode` the module can be run in `parametric` mode, where the colour matrix and white
  balance coefficients are used and then the RBF only comes into play for gamut mapping.
  the `data driven` mode works on an aribtrary list of source and target points which
  can be given in the parameters as `source` and `target` list of points.
  this parameter runs a ui group, so it will show/hide a few other elements.
* `gamut` the gamut can be left untouched, projected to spectral locus, rec2020, or rec709
* `picked` what to do with the picked input colour, if it is connected to the `picked` connector.
  it can be used as source for white balancing and/or deflickering.
* `matrix` input device transform mode: use the image matrix or a selection of presets, or the colour lut.
* `temp` if a clut is used, this allows to blend between the two illuminants. usually this
  is illuminant A and D65 and reflected in the values of the temperature here.
* `white` the white balance destination colour
* `mat` a hidden parameter containing the coefficients of the image matrix.
* `cnt` the number of patches to use in the rbf mapping
* `rbmap` the patch source and destination colours
* `import` press this button to import source and destination colours from a
  colour picker by the instance name as entered to the right. the picker should
  be attached to the output of this module and you have to keep the saturation
  slider at 1.0 when doing this. also the rbf needs to be set to identity
  (reduce number of patches, double click the sliders to reset to src).
  reference numbers for the picker can be obtained by presets for your target (such as cc24).
  

## connectors

* `input` the input colour buffer in camera rgb
* `output` the output in rec2020 rgb
* `clut` (optional) the color lookup table generated by the mkclut utility
* `picked` (optional) route picked colour for white balancing source in here
